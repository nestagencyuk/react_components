import { Meta, Story, Canvas, Preview, Props } from '@storybook/addon-docs/blocks'
import { Fragment, useContext, useState, useMemo } from 'react'
import { Text } from '../../components/Text'
import { Button } from '../../components/Button'
import { Input } from '../../components/Input'
import { ManageArrayContext, ManageArray } from '.'
import { FormV2, useField } from '@nestagencyuk/react_form-factory'

<Meta title="Context|Manage Array" component={ManageArray} />

# Manage Array
This is the Context implementation of the [Manage Array hook](/?path=/docs/hooks-manage-array--base). Useful for creating editable tables, or lists.

## Base
You can use `useContext` to access the array state. The table must be initiated with at least one blank row.

<Preview>
  <Story name="Base">
    {() => {
      const [value, setValue] = useState(null)
      const header = [
        { id: 'product_sku', name: 'Stock Keeping Unit (SKU)' },
        { id: 'product_description', name: 'Product Description' },
        { id: 'unit_of_measure', name: 'Unit of Measure' },
        { id: 'quantity', name: 'Quantity' },
        { id: 'batch', name: 'Batch'}
      ]
      const blankRow = { product_sku: null, product_description: null, unit_of_measure: null, quantity: null, batch: null }
      const Cell = ({ id }) => {
        const { value, valid, handleChange } = useField({ id })
        return (
          <td><Input className="w--100" id={id} value={value} onChange={handleChange} /></td>
        )
      }
      const Row = ({ data }) => {
        const { addItem, editItem, deleteItem } = useContext(ManageArrayContext)
        return (
          <FormV2 data={data} onSubmit={(data) => editItem(data)}>
            {({ handleSubmit }) => (
              <tr onBlur={handleSubmit}>
                {Object.keys(data).filter(x => x !== '_uid').map((x, i) => <Cell key={`cell-${x}-${i}`} id={x} />)}
                <td>
                  <Button className="w--50" variant="Secondary" onClick={() => addItem(data)}>Copy</Button>
                  <Button className="w--50" variant="Secondary" onClick={() => deleteItem(data._uid)}>Delete</Button>
                </td>
              </tr>
            )}
          </FormV2>
        )
      }
      return (
        <Fragment>
          <Text>Value:</Text>
          <pre className="p--md bg--ui-one text--sm">{JSON.stringify(value, null, 2)}</pre>
          <ManageArray
            initialArray={[
              { product_sku: null, product_description: null, unit_of_measure: null, quantity: null, batch: null },
              { product_sku: null, product_description: null, unit_of_measure: 2, quantity: null, batch: null },
            ]}
            >
            {({ array, addItem }) => (
              <Fragment>
                <form>
                  <table style={{ tableLayout: 'fixed', width: '100%' }}>
                    <thead>
                      <tr>
                        {header.map((x, i) => <th key={`header-${i}`}>{x.name}</th>)}
                        <th style={{ width: '200px' }}><Button className="w--100" onClick={() => addItem(blankRow)}>Add</Button></th>
                      </tr>
                    </thead>
                    <tbody>
                      {array.map((row, i) => (
                        <Row key={`row-${row._uid}`} data={row} />
                      ))}
                    </tbody>
                  </table>
                  <Button type="submit">Submit</Button>
                </form>
              </Fragment>
            )}
          </ManageArray>
        </Fragment>
      )
    }}
  </Story>
</Preview>
