import { Meta, Story, Canvas, Preview, Props } from '@storybook/addon-docs/blocks'
import { Fragment, useContext, useState } from 'react'
import { Text } from '../../components/Text'
import { Button } from '../../components/Button'
import { Field } from '../../components/Field'
import { Input } from '../../components/Input'
import { Select } from '../../components/Select'
import { Form, Field as FieldState } from '@nestagencyuk/react_form-factory'
import { useManageArray } from '.'

<Meta title="Hooks|Manage Array" component={null} />

# Manage Array
A hook for adding, editing and removing items from an array, e.g rows in a table.

## Base
The hook in its simplest form. For a string array where all values must be unique.

<Preview>
  <Story name="Base">
    {() => {
      const [editing, setEditing] = useState(false)
      const { array, addItem, editItem, deleteItem } = useManageArray()
      return (
        <Fragment>
          <Text>Value:</Text>
          <pre className="p--md bg--ui-one text--sm">{JSON.stringify(array, null, 2)}</pre>
          {array && array.map((x, i) => (
            <Form key={`form-${i}`} savedData={{ name: x }} onSubmit={(formData) => { editItem(formData.name, i); setEditing(false) }}>
              {({ handleSubmit }) => (
                <form style={{ display: 'flex' }} onSubmit={(e) => e.preventDefault()}>
                  <FieldState id="name">{(field) => <Field id={`name-${i}`} label="Name" disabled={!editing} {...field} />}</FieldState>
                  {editing ? (
                    <Button variant="Tertiary" size="Small" type="submit" onClick={handleSubmit}>Save</Button>
                  ) : (
                    <Button variant="Tertiary" size="Small" onClick={() => setEditing(true)}>Edit</Button>
                  )}
                  <Button className="m m--l-md" variant="Tertiary" size="Small" onClick={() => deleteItem(x)}>Delete</Button>
                </form>
              )}
            </Form>
          ))}
          <Form onSubmit={(formData) => addItem(formData.name)}>
            {({ valid, handleSubmit }) => (
              <form style={{ display: 'flex' }} onSubmit={handleSubmit}>
                <FieldState id="name" required>{(field) => <Field id="name" label="Name" {...field} />}</FieldState>
                <Button type="submit" disabled={!valid}>Add</Button>
              </form>
            )}
          </Form>
        </Fragment>
      )
    }}
  </Story>
</Preview>

## Object
The hook also accepts an array of objects. It will add a `_uid` property to each object with a generated unique id. You can filter this out in your final payload.

<Preview>
  <Story name="Object">
    {() => {
      const [editing, setEditing] = useState(false)
      const { array, addItem, editItem, deleteItem } = useManageArray()
      return (
        <Fragment>
          <Text>Value:</Text>
          <pre className="p--md bg--ui-one text--sm">{JSON.stringify(array, null, 2)}</pre>
          {array && array.map((x, i) => (
            <Form key={`form-${i}`} savedData={x} onSubmit={(formData) => { editItem(formData); setEditing(false) }}>
              {({ valid, handleSubmit }) => (
                <form style={{ display: 'flex' }}  onSubmit={(e) => e.preventDefault()}>
                  <FieldState id="name">
                    {(field) => <Field id={`name-${i}`} label="Name" {...field} />}
                  </FieldState>
                  <FieldState id="age">
                    {(field) => <Field id={`age-${i}`} label="Age" type="Number" {...field} />}
                  </FieldState>
                  <FieldState id="gender">
                    {(field) => (
                      <Field 
                        id={`gender-${i}`} 
                        label="Gender"
                        type="Select" 
                        options={[{ value:'male', label: 'Male'}, { value:'female', label: 'Female'}]} 
                        {...field} 
                      />
                    )}
                  </FieldState>
                  {editing ? (
                    <Button variant="Tertiary" size="Small" type="submit" onClick={handleSubmit}>Save</Button>
                  ) : (
                    <Button variant="Tertiary" size="Small" onClick={() => setEditing(true)}>Edit</Button>
                  )}
                  <Button className="m m--l-md" variant="Tertiary" size="Small" onClick={() => deleteItem(x)}>Delete</Button>
                </form>
              )}
            </Form>
          ))}
          <Form onSubmit={(formData) => addItem(formData)}>
            {({ valid, handleSubmit }) => (
              <form style={{ display: 'flex' }} onSubmit={handleSubmit}>
                <FieldState id="name" required>
                  {(field) => <Field id="name" label="Name" {...field} />}
                </FieldState>
                <FieldState id="age" required>
                  {(field) => <Field id="age" label="Age" type="Number" {...field} />}
                </FieldState>
                <FieldState id="gender" required>
                  {(field) => (
                    <Field 
                      id="gender" 
                      label="Gender" 
                      type="Select" 
                      options={[{ value:'male', label: 'Male'}, { value:'female', label: 'Female'}]} 
                      {...field} 
                    />
                  )}
                </FieldState>
                <Button type="submit" disabled={!valid}>Add</Button>
              </form>
            )}
          </Form>
        </Fragment>
      )
    }}
  </Story>
</Preview>

## Table
An example of a table with editable rows.

<Preview>
  <Story name="Table">
    {({ config = [
        [
          { id: 'name', type: 'Text', value: 'Jamie' }, 
          { id: 'age', type: 'Number', value: 26 }, 
          { id: 'gender', type: 'Select', value: 'male', options: [{ value:'male', label: 'Male'}, { value:'female', label: 'Female'}]}
        ],
        [
          { id: 'name', type: 'Text', value: 'Milly' }, 
          { id: 'age', type: 'Number', value: 27 }, 
          { id: 'gender', type: 'Select', value: 'female', options: [{ value:'male', label: 'Male'}, { value:'female', label: 'Female'}]}
        ],
      ]}) => {
      const [editing, setEditing] = useState(false)
      const { array, addItem, editItem, deleteItem } = useManageArray({ 
        initialArray: config.map((x) => x.reduce((acc, y) => ({ ...acc, [y.id]: y.value }), {}))
      })
      const blankRow = { name: null, age: null, gender: null }
      console.log(array)
      return (
        <Fragment>
          <Text>Value:</Text>
          <pre className="p--md bg--ui-one text--sm">{JSON.stringify(array, null, 2)}</pre>
          <table style={{ tableLayout: 'fixed', width: '100%' }}>
            <tr>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th style={{ width: '125px' }}><Button className="w--100" size="Small" onClick={() => addItem(blankRow)}>Add</Button></th>
            </tr>
            {array && array.map((x, i) => (
              <Form key={`form-${i}`} savedData={x} onSubmit={(formData) => editItem(formData)}>
                {({ valid, handleSubmit }) => (
                  <tr>
                    {(config[i] || config[0]).map((y) => (
                      <td onBlur={handleSubmit}>
                        <FieldState id={y.id}>
                          {(field) => y.type === 'Select' ? <Select {...y} {...field} /> : <Input {...y} {...field} />}
                        </FieldState>
                      </td>
                    ))}
                    <td>
                      <Button className="w--100" variant="Secondary" onClick={() => deleteItem(x)}>Delete</Button>
                    </td>
                  </tr>
                )}
              </Form>
            ))}
          </table>
        </Fragment>
      )
    }}
  </Story>
</Preview>
